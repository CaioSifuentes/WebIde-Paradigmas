<!doctype html>
<html>
  <head>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.27.2/full/pyodide.js"></script>
  </head>

  <body>
    <p>
      You can execute any Python code. Just enter something in the box below and
      click the button.
    </p>
    <textarea id="code" rows="5" cols="50">
a = 5
b = 10
c = a + b
print(c)
    </textarea><br>
    <button onclick="evaluatePython()">Run</button>
    <button onclick="startDebug()" id="debugButton">Debug</button>
    <button onclick="stepDebug()" disabled id="stepButton">Step</button>
    <button onclick="clearConsole()">Clear</button>
    <br />
    <br />
    <div>Output:</div>
    <textarea id="output" style="width: 100%;" rows="6" disabled></textarea>
    <button onclick="setCode(1)">Código 1</button>
    <button onclick="setCode(2)">Código 2</button>
    <button onclick="setCode(3)">Código 3</button>
    <button onclick="setCode(4)">Código 4</button>

    <div class="container">
      <h2>Tabela Gerada a Partir de um Objeto</h2>
      <div class="table-container">
          <table id="data-table">
              <thead>
                  <tr id="table-header"></tr>
              </thead>
              <tbody id="table-body"></tbody>
          </table>
      </div>
  </div>

    <script src="../utils/DebuggerMapper.js"></script>

    <script>
      const output = document.getElementById("output");
      const code = document.getElementById("code");
      const stepButton = document.getElementById("stepButton");
      const debugButton = document.getElementById("debugButton");

      let pyodideReadyPromise = loadPyodide();
      let debugLines = [];
      let currentLine = 0;
      let pyodide;
      let debugVars = {};

      function addToOutput(s) {
        output.value += s + "\n";
        output.scrollTop = output.scrollHeight;
      }

      function clearConsole() {
        currentLine = 0;
        debugLines = [];
        stepButton.disabled = true;
        debugButton.disabled = false;
        output.value = "";
      }

      async function evaluatePython() {
        pyodide = await pyodideReadyPromise;
        try {
          let result = pyodide.runPython(code.value);
          if (result != undefined) addToOutput(">>>\n" + result);
        } catch (err) {
          addToOutput("Error: " + err);
        }
      }

      async function startDebug() {
        pyodide = await pyodideReadyPromise;
        debugLines = code.value.split("\n");
        debugFormatedCode = formatDebugCode(debugLines);
        //console.log("Debuging: \n" + debugFormatedCode);
        pyodide.runPythonAsync(debugFormatedCode);

        stepButton.disabled = false;
        debugButton.disabled = true;
        output.value = "Debugging started...\n";
      }

      async function finishDebug() {
        debugLines = [];
        currentLine = 0

        stepButton.disabled = true;
        debugButton.disabled = false;
        output.value += "Debugging finished.\n";
      }

      async function stepDebug() {
        if (pyodide.globals.get("__debugFinishedFlag") === 0){
          pyodide.runPython("__debugCodeFlag = 1");
          await new Promise(resolve => setTimeout(resolve, 100));
          currentLine += 1;

          debugVars = pyodide.globals.get("__currentVars").toJs();
          criarTabela(debugVars);
        } else {
          finishDebug();
          debugVars = {};
        }
      }

      function criarTabela(obj) {
            const keys = Object.keys(obj); // Pega as chaves do objeto
            const tableHeader = document.getElementById("table-header");
            const tableBody = document.getElementById("table-body");

            // Limpa a tabela antes de adicionar dados
            tableHeader.innerHTML = "";
            tableBody.innerHTML = "";

            // Criar cabeçalhos
            keys.forEach(key => {
                const th = document.createElement("th");
                th.textContent = key;
                tableHeader.appendChild(th);
            });

            // Criar uma linha com os dados do objeto
            const tr = document.createElement("tr");
            keys.forEach(key => {
                const td = document.createElement("td");
                td.textContent = obj[key];
                tr.appendChild(td);
            });
            tableBody.appendChild(tr);
        }

    </script>




    <script>
        // Subscreve a função "console.log". Além de printar no console, também adiciona os argumentos da função no campo output.
        (function() {
            const originalLog = console.log;

            console.log = function(...args) {
                originalLog.apply(console, args);
                const message = args.join(" ");

                if (!message.startsWith("cl: ")){
                    output.value += message + "\n";
                    output.scrollTop = output.scrollHeight;
                }
            };
        })();
    </script>
    <script>
        function setCode(option) {
            let code = "";
            
            if (option === 1) {
                code = `a = 5\nb = 10\nc = a + b\nprint(c)`;
            } else if (option === 2) {
                code = `a = 0\nfor _ in range(10):\n   a += 1\n   a += 2\nprint(a)`;
            } else if (option === 3) {
                code = `a = 2\nif a % 2:\n  print('Par')\nelse:\n  print('Impar')`;
            } else if (option === 4) {
                code = `def func(a, b):\n return a + b\nprint(func(1, 2))`;
            }
            
            clearConsole();
            document.getElementById("code").value = code;
        }
    </script>
  </body>
</html>
